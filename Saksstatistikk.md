# Data til saksstatistikk

En tabell som inneholder data til saksstatistikk er lagt til i databasen. Denne tabellen inneholder data som er nødvendig for å generere saksstatistikk. 
Det blir lagt til rader i tabellen ved følgende hendelser:
- Opprettelse av vedtakutskast
- Vedtaksutkast sendt til kvalitetssikring
- Vedtaksutkast sendt tilbake til veileder av kvalitetssikrer
- Vedtaksutkast godkjent av kvalitetssikrer
- Ferdigbehandling av vedtaksutkast (vedtaket blir fattet)
- Sletting av av vedtaksutkast
- En ny veileder/kvalitetssikrer tar over vedtaksutkastet

### BigQuery
På BigQuery har vi en tabell som er 1-til-1 med tabellen SAK_STATISTIKK i databasen.
Team Sak og Team Oppfølging, som foreløpig er våre konsumenter, har hvert sitt view basert på denne tabellen.
Det er verdt å merke hva spørringen for disse viewene er da ingen av viewene har all data.
Viewene finner man inne i BigQuery (i Google-konsollen) i prosjektene `obo-dev` og `obo-prod` i datasettene `14a_vedtak_statistikk`.

Hendelsene over oppdaterer tabellen SAK_STATISTIKK i databasen. Dataene vil samtidig også bli dyttet opp til BigQuery.
<br>BigQuery dev: https://console.cloud.google.com/bigquery?ws=!1m4!1m3!3m2!1sobo-dev-1713!2s14a_vedtak_statistikk
<br>BigQuery prod: https://console.cloud.google.com/bigquery?ws=!1m4!1m3!3m2!1sobo-prod-fc62!2s14a_vedtak_statistikk  
Det er viktig å være klar over at BigQuery-tabellen (`statistikk_dvh_fellestabell`) ikke er en speiling av databasetabellen. 
Dataene legges til begge steder, samtidig, med samme data, men hvis noe skulle bli endret direkte i databasen så speiles ikke endringen i BigQuery.

### Beskrivelse av feltene i SAK_STATISTIKK

| Felt                    | Beskrivelse                                                                                                                                                                            | Mulige verdier i databasen                                                                                                                     | Merknader                                                                                                                                                                                             |
|-------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| SEKVENSNUMMER           | Felt for BigQuery tabeller.<br>Identifiserende unik verdi for hver enkelt rad på BigQuery.                                                                                             | Integer                                                                                                                                        | Kun i viewet til Team Sak.                                                                                                                                                                            |
| AKTOR_ID                | Aktør-IDen tilknyttet søker eller hovedaktør for ytelsen.                                                                                                                              | String(11)                                                                                                                                     |                                                                                                                                                                                                       |
| OPPFOLGING_PERIODE_UUID | UUID for gjeldende oppfølgingsperiode.                                                                                                                                                 | UUID                                                                                                                                           | Hentes fra databasen til veilarboppfolging. Kun i viewet til Team Oppfølging og heter oppfolgingsperiode.                                                                                             |
| BEHANDLING_ID           | Fagsystemets behandlings-ID. Tilsvarer ID i vedtak-tabellen. Er unik id for § 14 a-vedtaket.                                                                                           | Integer                                                                                                                                        | I viewet til Team Oppfølging heter dette feltet vedtak_id.                                                                                                                                            |
| RELATERT_BEHANDLING_ID  | Hvis behandlingen har oppsått med bakgrunn i en annen, skal den foregående behandlingen refereres til her.                                                                             | Integer                                                                                                                                        | BEHANDLING_ID fra tidligere vedtak i samme oppfølgingsperiode.                                                                                                                                        |
| RELATERT_FAGSYSTEM      | Hvis feltet relatertBehandlingId er populert skal denne fylles ut med fagsystemet til den relaterte behandlingen. Default kan være samme fagsystem.                                    | ARENA, OPPFOLGINGSVEDTAK_14A                                                                                                                   |                                                                                                                                                                                                       |
| SAK_ID                  | Sak-ID for arbeidsoppfølging, hentes fra veilarboppfolging.                                                                                                                            | String                                                                                                                                         | Tett knyttet til oppfølgingsperiode. Denne sak-IDen brukes også i andre behandlinger i løpet av en oppfølgingsperiode.                                                                                |
| MOTTATT_TID             | Tidspunkt for når behandlingen oppstår.<br>Dette er starten på beregning av saksbehandlingstid.                                                                                        | TIMESTAMP                                                                                                                                      | Førstegangsbehandling = oppfølgingsperiode.startDato, Revurdering = REGISTRERT_TID (når utkast ble opprettet)                                                                                         |
| REGISTRERT_TID          | Tidspunkt da behandlingen første gang ble registrert i fagsystemet. Det samme som vedtaksutkast ble opprettet.                                                                         | TIMESTAMP                                                                                                                                      |                                                                                                                                                                                                       |
| FERDIGBEHANDLET_TID     | Tidspunkt for fattet vedtak.                                                                                                                                                           | TIMESTAMP                                                                                                                                      | I viewet til Team oppfolging heter dette feltet vedtak_fattet_tid                                                                                                                                     |
| ENDRET_TID              | Tidspunkt for når en hendelse skjer og databaserad skrives til tabell SAK_STATISTIKK.                                                                                                  | TIMESTAMP                                                                                                                                      |                                                                                                                                                                                                       |
| TEKNISK_TID             | Tidspunkt for når en rad kommer til BigQuery.                                                                                                                                          | TIMESTAMP                                                                                                                                      | OBS: Dette feltet finnes kun på BigQuery, ikke i postgres-tabellen SAK_STATISTIKK.                                                                                                                    |
| SAK_YTELSE              | Kode som angir hvilken ytelse/stønad behandlingen gjelder.                                                                                                                             | ARBEIDSRETTET_OPPFOLGINGSBEHOV                                                                                                                 |                                                                                                                                                                                                       |
| BEHANDLING_TYPE         | Kode som angir hvilken type behandling det er snakk om.                                                                                                                                | FORSTEGANGSBEHANDLING, REVURDERING                                                                                                             |                                                                                                                                                                                                       |
| BEHANDLING_STATUS       | Kode som angir hvilken status behandlingen har.                                                                                                                                        | UNDER_BEHANDLING, SENDT_TIL_KVALITETSSIKRING, KVALITETSSIKRING_GODKJENT, FATTET, AVSLUTTET                                                     |                                                                                                                                                                                                       |
| BEHANDLING_RESULTAT     | Kode som angir resultatet av behandlingen. Innsatsgruppe i vårt tilfelle.                                                                                                              | GODE_MULIGHETER, TRENGER_VEILEDNING, TRENGER_VEILEDNING_NEDSATT_ARBEIDSEVNE, JOBBE_DELVIS, LITEN_MULIGHET_TIL_Å_JOBBE, AVBRUTT, FEILREGISTRERT |                                                                                                                                                                                                       |
| BEHANDLING_METODE       | Kode som angir om behandlingen er manuell eller to-trinns. <br> To-trinns vil skje ved kvalitetssikring som må gjøres ved innsatsgruppe "Jobbe delvis" og "Liten mulighet til å jobbe" | MANUELL, AUTOMATISK, TOTRINNS                                                                                                                  |                                                                                                                                                                                                       |
| INNSATSGRUPPE           | Innsatsgruppe, tilsvarer BEHANDLING_RESULTAT.                                                                                                                                          | GODE_MULIGHETER, TRENGER_VEILEDNING, TRENGER_VEILEDNING_NEDSATT_ARBEIDSEVNE, JOBBE_DELVIS, LITEN_MULIGHET_TIL_Å_JOBBE                          | Kun i viewet til Team Oppfølging.                                                                                                                                                                     |
| HOVEDMAL                | Hovedmål.                                                                                                                                                                              | SKAFFE_ARBEID, BEHOLDE_ARBEID.                                                                                                                 | Kun i viewet til Team Oppfølging.                                                                                                                                                                     |
| OPPRETTET_AV            | -5 ved kode 6<br>Nav-Ident på veileder som opprettet vedtakutkast.                                                                                                                     | String(7)                                                                                                                                      |                                                                                                                                                                                                       |
| SAKSBEHANDLER           | -5 ved kode 6<br>Nav-Ident på veileder som gjorde siste handling på vedtaket.                                                                                                          | String(7)                                                                                                                                      |                                                                                                                                                                                                       |
| ANSVARLIG_BESLUTTER     | -5 ved kode 6<br>Nav-Ident på kvalitetssikrer som godkjenner kvalitetssikring av vedtaket.                                                                                             | String(7)                                                                                                                                      | Blir kun satt ved to-trinnsbehandling.                                                                                                                                                                |
| ANSVARLIG_ENHET         | -5 ved kode 6<br>EnhetId på Nav-enhet som har ansvaret for behandlingen. Det samme som OPPFOLGINGSENHET_ID.                                                                            | String(4)                                                                                                                                      | Kontor der innbygger blir fulgt opp. Dersom person flytter midt i en behandlig vil denne endres ved nye hendelser på vedtaket. <br> I viewet til Team Oppfølging heter dette feltet oppfolgingsenhet. |
| FAGSYSTEM_NAVN          | Angir fagsystemets eget navn.                                                                                                                                                          | OPPFOLGINGSVEDTAK_14A                                                                                                                          |                                                                                                                                                                                                       |
| FAGSYSTEM_VERSJON       | Kode som sier hvilken versjon av kodebasen dataene er generert med bakgrunn i.                                                                                                         | String                                                                                                                                         | Image tag – hentes ut fra container i kjøretid.                                                                                                                                                       |


# Resending av statistikk
Ved tilfeller av feil i data vi har levert til Team Sak er det viktig at vi beholder prinsippet om at rader som allerede er i vår databse og ute på BigQuery er ikke-muterbare. Det vil si at vi heller lager nye rader med endringer enn å endre eksisterende rader.
Måten Team Sak identifiserer resendinger er ved at det kommer nye rader (med nye sekvensnumre), men `behandling_id` og `endret_tid` er de samme som tidligere. `behandling_id` og `endret_tid` blir til sammen en nøkkel for raden vi ønsker å endre. Når den da er lik en tidligere rad blir raden tolket som en resending.

Det finnes mange måter å utføre resending på, men for å slippe å hente ut data som vi må lagre på egen maskin, eller lage noe som gjør det vanskeligere å endre ved nye tilfeller har vi valgt å løse resending på denne måten:
Vi har en `SakStatistikkResendingService.kt` hvor vi har en funksjon med steg som utføres.
Logikken er å hente ut rader som skal endres, kopiere disse og endre ønskede felter, lagre dem i sak_statistikk-tabellen i db og så sende det til BQ.
Når man trenger å kjøre en resending endrer man derfor i funksjonen `resendStatistikk()` i `SakStatistikkResendingService.kt` og gjør endringer i stegene som er kommentert. Resten bør gå av seg selv.
Husk å kontakte Team Sak og Team Oppfølging for å verifisere at resending var vellykket.
